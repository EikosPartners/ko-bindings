{"version":3,"sources":["../src/clickoff.js"],"names":["has","object","canClickOff","element","clickTarget","cls","index","value","className","baseVal","split","filterFunc","indexOf","Element","isEqualNode","some","includes","excludes","parentNode","init","valueAccessor","allBindings","viewModel","va","wasRemoved","eventListener","Function","handler","TypeError","bind","event","call","target","apply","arguments","document","body","addEventListener","utils","domNodeDisposal","addDisposeCallback","removeEventListener","bindingHandlers","clickOff"],"mappings":";;AAAA;;;;AACA;;;;AACA;;;;;;AAIA;;;;;;;;;;;;;;;;;;;;;;;AAwBI,IAAIA,MAAM,kBAAKC,MAAL,CAAYD,GAAtB;;AAEA;;;;;;;;;;;;;AAaA,SAASE,WAAT,CAAqBC,OAArB,EAA8BC,WAA9B,EAA2C;AACvC,QAAIC,YAAJ;AAAA,QAASC,cAAT;AAAA,QAAgBC,cAAhB;;AAEA;AACA,WAAOP,IAAII,WAAJ,CAAP,EAAyB;;AAErB,YAAID,YAAYC,WAAhB,EAA6B;AACzB,mBAAO,KAAP;AACH;;AAED;AACA,YAAGJ,IAAII,YAAYI,SAAhB,EAA2B,SAA3B,CAAH,EAA0C;AACtCH,kBAAMD,YAAYI,SAAZ,CAAsBC,OAAtB,CAA8BC,KAA9B,CAAoC,GAApC,CAAN;AACH,SAFD,MAEO;AACHL,kBAAM,CAACD,YAAYI,SAAZ,IAAyB,EAA1B,EAA8BE,KAA9B,CAAoC,GAApC,CAAN;AACH;;AAGD,YAAIC,aAAa,SAAbA,UAAa,CAACJ,KAAD,EAAW;AACxB,mBAAQ,OAAOA,KAAP,KAAiB,QAAjB,IAA6BF,IAAIO,OAAJ,CAAYL,KAAZ,IAAqB,CAAC,CAApD,IACCA,iBAAiBM,OAAjB,IAA4BN,MAAMO,WAAN,CAAkBV,WAAlB,CADpC;AAEH,SAHD;;AAMA,YAAG,iBAAEW,IAAF,CAAO,KAAKC,QAAZ,EAAsBL,UAAtB,CAAH,EAAsC;AAClC,mBAAO,IAAP;AACH;;AAGD,YAAG,iBAAEI,IAAF,CAAO,KAAKE,QAAZ,EAAsBN,UAAtB,CAAH,EAAsC;AAClC,mBAAO,KAAP;AACH;;AAED;AACAP,sBAAcA,YAAYc,UAA1B;AACH;AACD,WAAO,IAAP;AACH;;AAED;;;;;;;;AAQA,SAASC,IAAT,CAAehB,OAAf,EAAwBiB,aAAxB,EAAuCC,WAAvC,EAAoDC,SAApD,EAAgE;AAC5D,QAAIC,KAAKH,eAAT;AAAA,QACII,aAAa,KADjB;AAAA,QAEIC,sBAFJ;;AAIA,QAAI,CAACzB,IAAIuB,EAAJ,CAAL,EAAc;AACV;AACH;;AAED;AACA,QAAIA,cAAcG,QAAlB,EAA4B;AACxB;AACAH,aAAK;AACDI,qBAASJ,EADR;AAEDP,sBAAUO,GAAGP,QAFZ;AAGDC,sBAAUM,GAAGN;AAHZ,SAAL;AAKH;;AAED;AACA,QAAI,EAAGM,GAAGI,OAAH,YAAsBD,QAAzB,CAAJ,EAAwC;AACpC,cAAM,IAAIE,SAAJ,CAAc,qCAAd,CAAN;AACH;;AAEDL,OAAGI,OAAH,GAAaJ,GAAGI,OAAH,CAAWE,IAAX,CAAgBP,SAAhB,CAAb;;AAEA;AACA,QAAG,CAACtB,IAAIuB,GAAGP,QAAP,CAAJ,EAAsB;AAClBO,WAAGP,QAAH,GAAc,CAAC,UAAD,CAAd;AACH;AACD,QAAG,CAAChB,IAAIuB,GAAGN,QAAP,CAAJ,EAAsB;AAClBM,WAAGN,QAAH,GAAc,CAAC,aAAD,CAAd;AACH;;AAEDQ,oBAAgB,uBAAWK,KAAX,EAAmB;AAC/B,YAAIN,UAAJ,EAAgB;AAAE;AAAS;AAC3B,YAAItB,YAAY6B,IAAZ,CAAiBR,EAAjB,EAAqBpB,OAArB,EAA8B2B,MAAME,MAApC,CAAJ,EAAiD;AAC7CT,eAAGI,OAAH,CAAWM,KAAX,CAAiB,IAAjB,EAAuB,CAACC,SAAD,EAAW,CAAC/B,OAAD,CAAX,CAAvB;AACH;AACJ,KALD;;AAOA;AACAgC,aAASC,IAAT,CAAcC,gBAAd,CAA+B,OAA/B,EAAwCZ,aAAxC;AACA,uBAAGa,KAAH,CAASC,eAAT,CAAyBC,kBAAzB,CAA4CrC,OAA5C,EAAqD,YAAY;AAC7DqB,qBAAa,IAAb;AACAW,iBAASC,IAAT,CAAcK,mBAAd,CAAkC,OAAlC,EAA2ChB,aAA3C;AACH,KAHD;AAIH;;AAED,mBAAGiB,eAAH,CAAmBC,QAAnB,GAA8B;AAC1BxB,UAAMA;AADoB,CAA9B","file":"clickoff.js","sourcesContent":["import core from 'scalejs.core';\nimport ko from 'knockout';\nimport _ from 'lodash';\n\n\n\n/**\n * A knockout binding that is used to allow detection of clicking on another element i.e. \"clicking off\"\n * @param {function} clickOff - the function that is called when click off\n * @param {object} clickOff - a configuration object with additional parameters to modify the behaviour of click off\n * @param {function} clickOff.handler -  the function that is called when click off\n * @param {string[]|HTMLElement[]} [clickOff.includes] - an array of class names or html dom elements that when clicked on will invoke the handler\n * @param {string[]|HTMLElement[]} [clickOff.excludes] - an array of class names or html dom elements that when clicked on will <strong>not</strong> invoke the handler\n * \n * @example <caption>Passing a function to value accessor</caption>\n * clickOff: function() {\n *   alert('it works!');\n * }\n * @example <caption>Passing an object with includes and excludes</caption>\n * clickOff: {\n *    handler: function ( ) {\n *        alert('it works!');\n *    },\n *    includes: ['clickOn', 'mainContent'],\n *    excludes: ['clickOff', 'titleBar']\n * }\n * @module clickOff\n */\n\n\n    let has = core.object.has;\n\n    /**\n     *\n     * 1. click off should be invoked if the click target is not the element\n     *    or a child of the element bound to click-off\n     * 2. click off should also be invoked if the target or one of the parents\n     *    of the target include a class name that matches this.includes\n     * 3. the opposite applies for this.excludes\n     * @private\n     * @param  {HTMLElement} element        the element that has click-off bound to it\n     * @param  {HTMLElement} clickTarget    the target of the click\n     * @return {boolean}\n     */\n\n    function canClickOff(element, clickTarget) {\n        let cls, index, value;\n\n        //loop from click target to root parent of click target\n        while (has(clickTarget)) {\n\n            if (element === clickTarget) {\n                return false;\n            }\n\n            //clickTarget.className.baseVal is the way to get classNames for SVG elements (path, etc)\n            if(has(clickTarget.className, 'baseVal')) {\n                cls = clickTarget.className.baseVal.split(' ');\n            } else {\n                cls = (clickTarget.className || '').split(' ');\n            }\n\n\n            let filterFunc = (value) => {\n                return (typeof value === 'string' && cls.indexOf(value) > -1)\n                    || (value instanceof Element && value.isEqualNode(clickTarget));\n            }\n\n\n            if(_.some(this.includes, filterFunc)) {\n                return true;\n            }\n\n\n            if(_.some(this.excludes, filterFunc)) {\n                return false;\n            }\n\n            // move up in the dom\n            clickTarget = clickTarget.parentNode;\n        }\n        return true;\n    }\n\n    /**\n     * clickOff binding - A binding that invokes a handler when the user clicks somewhere else\n     * @private\n     * @param  {HTMLElement} element        the dom element clickOff is bound to\n     * @param  {Function} valueAccessor     the options passed to the clickOff binding\n     * @param  {type} allBindings           description\n     * @param  {type} viewModel             description\n     */\n    function init( element, valueAccessor, allBindings, viewModel ) {\n        let va = valueAccessor(),\n            wasRemoved = false,\n            eventListener;\n\n        if (!has(va)) {\n            return;\n        }\n\n        // Normalize value accessor\n        if (va instanceof Function) {\n            // convert function to expected object\n            va = {\n                handler: va,\n                includes: va.includes,\n                excludes: va.excludes\n            };\n        }\n\n        // enforce handler function\n        if (! (va.handler instanceof Function)) {\n            throw new TypeError('clickoff: handler function required');\n        }\n\n        va.handler = va.handler.bind(viewModel);\n\n        // provide defaults for includes and excludes\n        if(!has(va.includes)) {\n            va.includes = ['clickoff'];\n        }\n        if(!has(va.excludes)) {\n            va.excludes = ['no-clickoff'];\n        }\n\n        eventListener = function ( event ) {\n            if (wasRemoved) { return; }\n            if (canClickOff.call(va, element, event.target)) {\n                va.handler.apply(this, [arguments,[element]]);\n            }\n        };\n\n        // add handler to body and create dom removal callback for cleanup\n        document.body.addEventListener('click', eventListener);\n        ko.utils.domNodeDisposal.addDisposeCallback(element, function () {\n            wasRemoved = true;\n            document.body.removeEventListener('click', eventListener);\n        });\n    }\n\n    ko.bindingHandlers.clickOff = {\n        init: init\n    };\n"]}